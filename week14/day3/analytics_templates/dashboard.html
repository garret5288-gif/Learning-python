{% extends 'base.html' %}
{% block title %}Dashboard · Personal Analytics{% endblock %}
{% block content %}
<div class="row g-3 mb-4">
    <div class="col-12 col-lg-5">
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">Add Metric</h5>
                <form method="post" class="row g-2">
                    <input type="hidden" name="mode" value="new_metric">
                    <div class="col-6"><input name="name" class="form-control" placeholder="Name" required></div>
                    <div class="col-4"><input name="unit" class="form-control" placeholder="Unit"></div>
                    <div class="col-2 d-grid"><button class="btn btn-primary">Save</button></div>
                </form>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Quick Entry</h5>
                <form method="post" class="row g-2">
                    <input type="hidden" name="mode" value="new_entry">
                    <div class="col-4">
                        <select name="metric_id" class="form-select" required>
                            <option value="" disabled selected>Metric</option>
                            {% for s in summaries %}<option value="{{ s.metric.id }}">{{ s.metric.name }}</option>{%
                            endfor %}
                        </select>
                    </div>
                    <div class="col-3"><input name="value" type="number" step="any" class="form-control"
                            placeholder="Value" required></div>
                    <div class="col-3"><input name="note" class="form-control" placeholder="Note"></div>
                    <div class="col-2 d-grid"><button class="btn btn-secondary">Add</button></div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-7">
        <div class="row g-3">
            {% for s in summaries %}
            <div class="col-12 col-md-6">
                <div class="card metric-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h6 class="mb-0"><a href="{{ url_for('metric_detail', metric_id=s.metric.id) }}">{{
                                    s.metric.name }}</a></h6>
                            {% set t = s.trend %}
                            <span
                                class="small {% if t=='up' %}trend-up{% elif t=='down' %}trend-down{% else %}trend-steady{% endif %}">{{
                                t }}</span>
                        </div>
                        {% if s.stats %}
                        <div class="small text-muted mb-1">min {{ s.stats.min }} · max {{ s.stats.max }} · avg {{
                            '%.2f'|format(s.stats.avg) }}</div>
                        <canvas id="spark{{ s.metric.id }}" class="sparkline"
                            data-points='{{ s.stats.spark|tojson }}'></canvas>
                        {% else %}
                        <div class="text-muted small">No entries yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if not summaries %}
            <div class="col-12">
                <p class="text-muted">Add a metric to get started.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    // Initialize all sparklines after DOM load
    document.querySelectorAll('canvas.sparkline[data-points]').forEach(cv => {
        try {
            const data = JSON.parse(cv.getAttribute('data-points'));
            new Chart(cv, {
                type: 'line',
                data: {
                    labels: data.map(d => d.day.slice(5)),
                    datasets: [{
                        data: data.map(d => d.avg),
                        borderColor: '#0d6efd',
                        tension: .3,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        } catch (e) { console.warn('Spark init failed', e); }
    });
</script>
{% endblock %}